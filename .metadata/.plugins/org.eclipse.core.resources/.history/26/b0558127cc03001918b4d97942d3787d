package udp;
import java.net.*;
import java.io.*;
//import java.util.concurrent.TimeUnit;

public class UDPServer {

  public static void main (String args[]) {

    try {
      DatagramSocket socketUDP = new DatagramSocket(6789);
      byte[] bufer = new byte[1000];

      while (true) {
        DatagramPacket peticion =
          new DatagramPacket(bufer, bufer.length);

        socketUDP.receive(peticion);

        byte[] data2 = new byte[peticion.getLength()];
        System.arraycopy(peticion.getData(), peticion.getOffset(), data2, 0, peticion.getLength());
        String msg = new String (data2);
        System.out.println("MENSAJE DATA: " + msg);
        System.out.println("STRING LENGTH: " + msg.length() + "\n");

        JSONParser parser = new JSONParser();
        JSONObject mensaje = (JSONObject) parser.parse(msg);

        System.out.print("Datagrama recibido del host: " +
                           peticion.getAddress());
        System.out.println(" desde el puerto remoto: " +
                           peticion.getPort());

        DatagramPacket respuesta =
          new DatagramPacket(peticion.getData(), peticion.getLength(),
                             peticion.getAddress(), peticion.getPort());

          /*System.out.println("Sleeping");
          TimeUnit.SECONDS.sleep(30);
          System.out.println("AWAKE");*/

        socketUDP.send(respuesta);
      }

    } catch (SocketException e) {
      System.out.println("Socket: " + e.getMessage());
    } catch (IOException e) {
      System.out.println("IO: " + e.getMessage());
    } /*catch (InterruptedException e){
      System.out.println("IE: " + e.getMessage());
    } */catch (ParseException e){
     System.out.println("PE: " + e.getMessage());
    }
  }
}